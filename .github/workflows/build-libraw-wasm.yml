name: Build LibRaw WASM

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    container: emscripten/emsdk:3.1.60
    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Install build deps
        run: |
          apt-get update -y
          apt-get install -y autoconf automake libtool pkg-config git build-essential

      - name: Fetch LibRaw 0.21.4
        run: |
          git clone --depth=1 --branch 0.21.4 https://github.com/LibRaw/LibRaw.git libraw-src
          ls -la libraw-src

      - name: Prepare autotools
        working-directory: libraw-src
        run: |
          autoreconf -fi

      - name: Configure (emscripten)
        working-directory: libraw-src
        env:
          EMSDK: /emsdk_portable
        run: |
          set -e
          echo "Configuring for cross-compile (Emscripten)"
          echo "Build triplet: $(gcc -dumpmachine)"
          # Force cross-compile so configure does not try to run a.out
          export CC=emcc
          export CXX=em++
          export AR=emar
          export RANLIB=emranlib
          export CFLAGS="-O3 -pthread -matomics -mbulk-memory -s USE_PTHREADS=1"
          export CXXFLAGS="-O3 -pthread -matomics -mbulk-memory -s USE_PTHREADS=1"
          export LDFLAGS="-pthread -matomics -mbulk-memory -s USE_PTHREADS=1"
          ./configure \
            --host=wasm32-unknown-emscripten \
            --build=$(gcc -dumpmachine) \
            --disable-shared --enable-static \
            --disable-openmp || true

      - name: Build static lib
        working-directory: libraw-src
        run: |
          make clean || true
          make -j2
          echo "Built files:" && ls -la . src/*.o *.a || true

      - name: Add wrapper
        run: |
          cat > libraw_wrapper.c <<'EOF'
          #include "libraw-src/libraw/libraw.h"
          #include <emscripten/emscripten.h>
          #include <stdlib.h>
          #include <string.h>

          EMSCRIPTEN_KEEPALIVE
          void* lr_init() { 
              libraw_data_t* handle = libraw_init(0);
              if (handle) {
                  // Configure output parameters for color processing
                  handle->params.output_color = 1;      // 1 = sRGB
                  handle->params.output_bps = 16;       // 16-bit output
                  handle->params.use_camera_wb = 1;     // Use camera white balance
                  handle->params.no_auto_bright = 0;    // Enable auto-brightness
                  handle->params.gamma_16bit = 1;       // Apply gamma for 16-bit
              }
              return handle;
          }

          EMSCRIPTEN_KEEPALIVE
          int lr_open_buffer(void* h, void* buf, size_t size) { return libraw_open_buffer((libraw_data_t*)h, buf, size); }

          EMSCRIPTEN_KEEPALIVE
          int lr_unpack(void* h) { return libraw_unpack((libraw_data_t*)h); }

          EMSCRIPTEN_KEEPALIVE
          int lr_process(void* h) { return libraw_dcraw_process((libraw_data_t*)h); }

          EMSCRIPTEN_KEEPALIVE
          void* lr_make_image(void* h, int* w, int* hgt, int* type) {
            libraw_processed_image_t* img = libraw_dcraw_make_mem_image((libraw_data_t*)h, NULL);
            if (!img) return NULL;
            *w = img->width; *hgt = img->height; *type = img->type; // type 1=8bit, 2=16bit RGB
            return img->data;
          }

          EMSCRIPTEN_KEEPALIVE
          void lr_close(void* h) { libraw_close((libraw_data_t*)h); }
          EOF

      - name: Link to wasm
        run: |
          set -e
          # Locate the produced static library (path differs by autotools setup)
          LIBRAW_A=$(find libraw-src -name 'libraw.a' -print -quit)
          echo "Using static lib at: ${LIBRAW_A}"
          emcc -O3 \
            -s WASM=1 -s MODULARIZE=1 -s EXPORT_NAME='LibRawModule' \
            -s ALLOW_MEMORY_GROWTH=1 \
            -s USE_PTHREADS=1 \
            -pthread -matomics -mbulk-memory \
            -I libraw-src \
            libraw_wrapper.c "${LIBRAW_A}" \
            -o libraw.js \
            -s EXPORTED_FUNCTIONS="['_malloc','_free']" \
            -s EXPORTED_RUNTIME_METHODS="['ccall','cwrap']"

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: libraw-wasm
          path: |
            libraw.js
            libraw.wasm
